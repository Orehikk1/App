import SwiftUI
import UIKit
import CoreMotion

// üìå –ú–æ–¥–µ–ª—å –∫–∞—Ä—Ç–æ—á–∫–∏ (Card)
struct Card: Identifiable, Codable, Equatable {
    let id: UUID
    let title: String
    let content: String
    let imageName: String
    init(id: UUID = UUID(), title: String, content: String, imageName: String) {
        self.id = id
        self.title = title
        self.content = content
        self.imageName = imageName
    }
}

// üìå –ú–æ–¥–µ–ª—å –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç
struct ExchangeRateResponse: Codable {
    let conversion_rates: [String: Double]
}

// üìå ViewModel (–∫–∞—Ä—Ç–æ—á–∫–∏, –∫—É—Ä—Å EUR ‚Üí HUF)
class CardViewModel: ObservableObject {
    @Published var cards: [Card] = []
    @Published var euroToHufRate: Double? = nil

    init() {
        self.cards = loadCards()
        fetchExchangeRates()
    }

    // üìå –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ EUR ‚Üí HUF
    func fetchExchangeRates() {
        guard let url = URL(string: "https://v6.exchangerate-api.com/v6/e68a27854c27f7174870f216/latest/EUR") else {
            print("‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π URL")
            return
        }

        let task = URLSession.shared.dataTask(with: url) { data, _, error in
            guard let data = data, error == nil else {
                print("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: \(error?.localizedDescription ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")")
                return
            }

            do {
                let decodedData = try JSONDecoder().decode(ExchangeRateResponse.self, from: data)
                DispatchQueue.main.async {
                    self.euroToHufRate = decodedData.conversion_rates["HUF"]
                }
            } catch {
                print("‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: \(error)")
            }
        }
        task.resume()
    }
}

// üìå –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ `cards.json`
func loadCards() -> [Card] {
    guard let url = Bundle.main.url(forResource: "cards", withExtension: "json") else {
        print("‚ùå –§–∞–π–ª `cards.json` –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return []
    }
    do {
        let data = try Data(contentsOf: url)
        let decodedCards = try JSONDecoder().decode([Card].self, from: data)
        return decodedCards
    } catch {
        print("‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: \(error)")
        return []
    }
}

// ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
struct BlurView: UIViewRepresentable {
    var style: UIBlurEffect.Style
    
    func makeUIView(context: Context) -> UIVisualEffectView {
        let view = UIVisualEffectView(effect: UIBlurEffect(style: style))
        return view
    }
    
    func updateUIView(_ uiView: UIVisualEffectView, context: Context) {}
}

// ‚úÖ –ö—É—Ä—Å –≤–∞–ª—é—Ç —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞
struct ExchangeRateView: View {
    @ObservedObject var viewModel: CardViewModel
    @State private var xOffset: CGFloat = 0
    @State private var yOffset: CGFloat = 0
    private let motionManager = CMMotionManager()
    
    var body: some View {
        VStack {
            if let rate = viewModel.euroToHufRate {
                VStack(alignment: .center, spacing: 8) {
                    Text("üí± Exchange Rate")
                        .font(.headline)
                        .foregroundColor(.black.opacity(0.8)) // üîπ –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                    
                    Text("1 EUR = \(rate, specifier: "%.2f") HUF")
                        .font(.largeTitle.bold())
                        .foregroundColor(.black) // üîπ –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                        .padding(.vertical, 5)
                    
                    Text("Updated live")
                        .font(.caption)
                        .foregroundColor(.black.opacity(0.6)) // üîπ –°–µ—Ä—ã–π –æ—Ç—Ç–µ–Ω–æ–∫
                }
                .padding()
                .background(
                    RoundedRectangle(cornerRadius: 20)
                        .fill(Color.white) // ‚úÖ –§–æ–Ω —Å—Ç–∞–ª –±–µ–ª—ã–º
                        .shadow(color: .black.opacity(0.2), radius: 10) // ‚úÖ –¢–µ–Ω—å
                )
                .offset(x: xOffset, y: yOffset) // üìå –†–µ–∞–∫—Ü–∏—è –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ
                .animation(.spring(response: 0.5, dampingFraction: 0.6), value: xOffset)
                .onAppear {
                    startMotionUpdates()
                }
            } else {
                Text("Loading exchange rate EUR ‚Üí HUF...")
                    .foregroundColor(.gray)
                    .font(.headline)
                    .padding()
            }
        }
    }
    
    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–æ–º
    private func startMotionUpdates() {
        if motionManager.isAccelerometerAvailable {
            motionManager.accelerometerUpdateInterval = 0.1
            motionManager.startAccelerometerUpdates(to: .main) { data, error in
                guard let data = data, error == nil else { return }
                
                // üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è
                withAnimation(.easeOut(duration: 0.3)) {
                    xOffset = CGFloat(data.acceleration.y) * 15 // –ß–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–¥–≤–∏–≥
                    yOffset = CGFloat(data.acceleration.x) * -15
                }
            }
        }
    }
}

// ‚úÖ –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ (–∫–∞—Ä—Ç–æ—á–∫–∏, –∫—É—Ä—Å EUR ‚Üí HUF)
struct ContentView: View {
    @StateObject private var viewModel = CardViewModel()
    let columns = [GridItem(.adaptive(minimum: 150), spacing: 20)]
    
    //üîπ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (—Å–∫—Ä—ã—Ç–æ/–ø–æ–∫–∞–∑–∞–Ω–æ)
    @State private var isTextExpanded = false

    var body: some View {
        NavigationView {
            ZStack {
                FuturisticGradientBackground() // üîπ –ì—Ä–∞–¥–∏–µ–Ω—Ç
                              // AnimatedWaveBackground()   // üîπ –í–æ–ª–Ω—ã
                              // BlurBackground()           // üîπ –†–∞–∑–º—ã—Ç–∏–µ
            
            ScrollView {
                VStack(spacing: 20) {
                    // ‚úÖ –ö—É—Ä—Å –≤–∞–ª—é—Ç —Å –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–æ–º
                    ExchangeRateView(viewModel: viewModel)
                        .padding(.top, 10)

                    // üìå –ó–∞–≥–æ–ª–æ–≤–æ–∫
                    Text("Information for Guides")
                        .font(.largeTitle)
                        .bold()
                        .foregroundColor(.primary)
                        .padding(.top)
                    
                    VStack {
                        Button(action: {
                            withAnimation(.easeInOut(duration: 0.3)) {isTextExpanded.toggle()
                            }
                        }) {
                            HStack {
                                Text("Read More")
                                    .font(.headline)
                                    .foregroundColor(.white)
                                
                                Image(systemName: isTextExpanded ? "chevron.up" : "chevron.down")
                                    .foregroundColor(.white)
                            }
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(isTextExpanded ? Color.blue : Color.gray.opacity(0.8))
                            .cornerRadius(15)
                            .shadow(radius: 5)
                        }
                        
                        ZStack {
                            VStack(alignment: .leading, spacing: 10) {
                                if isTextExpanded {
                                    Text("""
                        This short book was written for the guides of Segway tours, and it contains all the information you need about buildings and monuments during the stops of our tours.
                        """)
                                    Text("""
                        - **Regular History** will be marked with a **#** sign.
                        - **Segway stop History** will be marked with a **‚Ä¢** sign.
                        """)
                                    .font(.headline)
                                    Text("""
                        The reason why you should know all this is that some tourists might ask more questions about the past of the city and the country. We really hope this guide is understandable and clear.
                        """)
                                }
                            }
                            .font(.body)
                            .foregroundColor(.primary)
                            .padding()
                            .background(Color(UIColor.systemBackground))
                            .clipShape(RoundedRectangle(cornerRadius: 15))
                            .shadow(radius: 5)
                            .frame(maxWidth: .infinity, alignment: .leading) // üëà **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**
                            .padding(.horizontal)
                            .padding(.vertical, 5)
                            .animation(.easeInOut(duration: 0.3), value: isTextExpanded)
                            .transition(.opacity)
                        }
                        .frame(height: isTextExpanded ? nil : 0) // üîπ –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –¥–≤–∏–≥–∞–ª–∏—Å—å
                        .opacity(isTextExpanded ? 1 : 0)
                        .animation(.easeInOut(duration: 0.3), value: isTextExpanded)
                        .clipped()
                }
                    
                    // üìå –ö–∞—Ä—Ç–æ—á–∫–∏
                    LazyVGrid(columns: columns, spacing: 20) {
                        ForEach(viewModel.cards) { card in
                            NavigationLink(destination: CardDetailView(card: card)) {
                                CardView(card: card)
                            }
                            .buttonStyle(PlainButtonStyle())
                        }
                    }
                    .padding()
                    .id("gridView")
                    .animation(nil, value: UUID())

                    // üìå –ë–ª–æ–∫ —Å —Å–æ—Ü—Å–µ—Ç—è–º–∏
                    VStack(spacing: 10) {
                        Text("Our social media!")
                            .font(.headline)
                            .foregroundColor(.primary)

                        HStack(spacing: 20) {
                            SocialMediaButton(iconName: "instagram", url: "https://www.instagram.com/@segwaybp")
                            SocialMediaButton(iconName: "youtube", url: "https://www.youtube.com/@segwaybp-budapest")
                            SocialMediaButton(iconName: "tiktok", url: "https://www.tiktok.com/@segwaybp")
                        }
                    }
                    .padding(.top, 20)
                    
                    Text("Written by Ern≈ë G√°sp√°r")
                        .font(.footnote)
                        .foregroundColor(.gray)
                        .padding(.bottom, 20)
                }
            }
        }
    }
}

// üìå –í–∏–¥ –∫–∞—Ä—Ç–æ—á–∫–∏
struct CardView: View {
    let card: Card
    var body: some View {
        VStack {
            Image(card.imageName)
                .resizable()
                .scaledToFill()
                .frame(width: 150, height: 150)
                .clipShape(RoundedRectangle(cornerRadius: 20))
                .shadow(radius: 5)
            Text(card.title)
                .font(.headline)
                .foregroundColor(.primary)
                .multilineTextAlignment(.center)
                .frame(width: 150, height: 40)
        }
        .contentShape(Rectangle())
    }
}

    // üìå –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–∫–∏
    func openURL(_ urlString: String) {
        if let url = URL(string: urlString) {
            UIApplication.shared.open(url)
        }
    }

    // üìå –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ (–±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏)
    func parseContent(_ content: String) -> [String] {
        return content.components(separatedBy: "\n\n")
    }

    // üìå –ö–Ω–æ–ø–∫–∞ —Å–æ—Ü—Å–µ—Ç–µ–π
    struct SocialMediaButton: View {
        let iconName: String
        let url: String

        var body: some View {
            Button(action: {
                openURL(url)
            }) {
                Image(iconName)
                    .resizable()
                    .frame(width: 40, height: 40)
                    .clipShape(Circle())
                    .shadow(radius: 5)
            }
        }
    }

    // üìå –î–µ—Ç–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ (—Å —Ñ–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞)
    struct CardDetailView: View {
        let card: Card

        var body: some View {
            ScrollView {
                VStack(alignment: .leading, spacing: 15) {
                    let sections = parseContent(card.content)

                    ForEach(sections.indices, id: \.self) { index in
                        let section = sections[index]

                        if section.starts(with: "[IMAGE:") {
                            let imageName = section
                                .replacingOccurrences(of: "[IMAGE:", with: "")
                                .replacingOccurrences(of: "]", with: "")

                            if let uiImage = UIImage(named: imageName) {
                                Image(uiImage: uiImage)
                                    .resizable()
                                    .scaledToFit()
                                    .cornerRadius(15)
                                    .padding(.vertical, 10)
                            } else {
                                Text("‚ö†Ô∏è Image '\(imageName)' not found!")
                                    .foregroundColor(.red)
                                    .font(.caption)
                            }
                        } else {
                            // üìå –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                            if let attributedString = try? AttributedString(markdown: section) {
                                Text(attributedString)
                                    .font(.body)
                                    .foregroundColor(.primary)
                                    .padding(.vertical, 5)
                            } else {
                                Text(section)
                                    .font(.body)
                                    .foregroundColor(.primary)
                                    .padding(.vertical, 5)
                            }
                        }
                    }
                }
                .padding()
            }
            .navigationTitle(card.title)
        }
    }

    // ‚úÖ –§—É—Ç—É—Ä–∏—Å—Ç–∏—á–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
    struct FuturisticGradientBackground: View {
        var body: some View {
            LinearGradient(
                gradient: Gradient(colors: [Color.blue.opacity(0.7), Color.purple.opacity(0.8), Color.black]),
                startPoint: .topLeading,
                endPoint: .bottomTrailing
            )
            .ignoresSafeArea()
        }
    }

    // ‚úÖ –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ª–Ω—ã
    struct AnimatedWaveBackground: View {
        @State private var move = false

        var body: some View {
            ZStack {
                Color.black.ignoresSafeArea()
                Circle()
                    .fill(Color.blue.opacity(0.4))
                    .frame(width: 600, height: 600)
                    .offset(x: move ? 100 : -100, y: move ? -200 : 200)
                    .blur(radius: 150)
                    .animation(Animation.easeInOut(duration: 5).repeatForever(autoreverses: true), value: move)

                Circle()
                    .fill(Color.purple.opacity(0.3))
                    .frame(width: 500, height: 500)
                    .offset(x: move ? -150 : 150, y: move ? 150 : -150)
                    .blur(radius: 120)
                    .animation(Animation.easeInOut(duration: 6).repeatForever(autoreverses: true), value: move)
            }
            .onAppear { move.toggle() }
        }
    }

    // ‚úÖ –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞
    struct BlurBackground: View {
        var body: some View {
            ZStack {
                Image("background") // üîπ –ó–∞–º–µ–Ω–∏ "background" –Ω–∞ —Å–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    .resizable()
                    .scaledToFill()
                    .ignoresSafeArea()
                    .blur(radius: 10)
                    .opacity(0.8)

                Color.black.opacity(0.3)
                    .ignoresSafeArea()
            }
        }
    }

    // üìå –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    @main
    struct GuideApp: App {
        var body: some Scene {
            WindowGroup {
                ContentView()
            }
        }
    }
